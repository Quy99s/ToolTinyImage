#!/bin/bash

# Script ch√≠nh c·ªßa ·ª©ng d·ª•ng Tool Tiny Image
PROJECT_DIR="/Users/quy99/Desktop/MyFolder/Extention/ToolTinyImage"

# Ki·ªÉm tra v√† s·ª≠a quy·ªÅn th∆∞ m·ª•c
echo "üîß Ki·ªÉm tra quy·ªÅn th∆∞ m·ª•c..."
if [ ! -w "$PROJECT_DIR" ]; then
    echo "‚ö†Ô∏è C·∫ßn s·ª≠a quy·ªÅn th∆∞ m·ª•c..."
    chmod -R 755 "$PROJECT_DIR" 2>/dev/null || true
fi

# Chuy·ªÉn v√†o th∆∞ m·ª•c project
cd "$PROJECT_DIR" || exit 1

# Ki·ªÉm tra Node.js v·ªõi nhi·ªÅu ƒë∆∞·ªùng d·∫´n
check_node_gui() {
    # Th·ª≠ c√°c ƒë∆∞·ªùng d·∫´n ph·ªï bi·∫øn
    local node_paths=(
        "/usr/local/bin/node"
        "/opt/homebrew/bin/node" 
        "/usr/bin/node"
        "$(which node 2>/dev/null)"
    )
    
    for node_path in "${node_paths[@]}"; do
        if [ -x "$node_path" ]; then
            export NODE_PATH="$node_path"
            export PATH="$(dirname "$node_path"):$PATH"
            return 0
        fi
    done
    
    # T√¨m trong to√†n h·ªá th·ªëng
    NODE_FOUND=$(find /usr /opt 2>/dev/null | grep -E "bin/node$" | head -1)
    if [ -n "$NODE_FOUND" ]; then
        export PATH="$(dirname "$NODE_FOUND"):$PATH"
        return 0
    fi
    
    return 1
}

if ! check_node_gui && ! command -v node &> /dev/null; then
    # Hi·ªÉn th·ªã dialog h·ªèi c√≥ mu·ªën c√†i ƒë·∫∑t kh√¥ng
    RESPONSE=$(osascript -e 'display dialog "‚ùå Node.js ch∆∞a ƒë∆∞·ª£c c√†i ƒë·∫∑t!\n\nB·∫°n c√≥ mu·ªën t·ª± ƒë·ªông c√†i ƒë·∫∑t Node.js kh√¥ng?" buttons {"Tho√°t", "C√†i ƒë·∫∑t"} default button "C√†i ƒë·∫∑t"')
    
    if [[ $RESPONSE == *"C√†i ƒë·∫∑t"* ]]; then
        # M·ªü terminal ƒë·ªÉ c√†i ƒë·∫∑t Node.js
        osascript -e "tell application \"Terminal\" to do script \"echo 'üì¶ ƒêang c√†i ƒë·∫∑t Node.js...' && if ! command -v brew &> /dev/null; then echo 'C√†i ƒë·∫∑t Homebrew...'; /bin/bash -c '\$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)'; fi && echo 'C√†i ƒë·∫∑t Node.js...' && brew install node && echo '‚úÖ Ho√†n th√†nh! ƒê√≥ng terminal n√†y v√† th·ª≠ l·∫°i Tool Tiny Image.' && read -p 'Nh·∫•n Enter ƒë·ªÉ ƒë√≥ng...'\""
        exit 0
    else
        osascript -e 'display dialog "Vui l√≤ng c√†i ƒë·∫∑t Node.js t·ª´:\nhttps://nodejs.org\n\nSau ƒë√≥ th·ª≠ l·∫°i Tool Tiny Image." buttons {"OK"} default button "OK"'
        exit 1
    fi
fi

# Ki·ªÉm tra v√† c√†i ƒë·∫∑t dependencies n·∫øu c·∫ßn
if [ ! -d "node_modules" ] || [ ! -f "node_modules/.bin/electron" ]; then
    osascript -e 'display dialog "üì¶ ƒêang c√†i ƒë·∫∑t Tool Tiny Image l·∫ßn ƒë·∫ßu...\nQu√° tr√¨nh n√†y c√≥ th·ªÉ m·∫•t v√†i ph√∫t." buttons {"OK"} default button "OK"'
    
    # M·ªü terminal ƒë·ªÉ hi·ªÉn th·ªã qu√° tr√¨nh c√†i ƒë·∫∑t v·ªõi x·ª≠ l√Ω l·ªói quy·ªÅn
    osascript -e "tell application \"Terminal\" to do script \"
export PATH='/usr/local/bin:/opt/homebrew/bin:/usr/bin:\$PATH'
echo 'üì¶ ƒêang c√†i ƒë·∫∑t Tool Tiny Image...'
echo 'S·ª≠a quy·ªÅn th∆∞ m·ª•c...'
sudo chown -R \$(whoami) '$PROJECT_DIR' 2>/dev/null || true
chmod -R 755 '$PROJECT_DIR' 2>/dev/null || true
cd '$PROJECT_DIR' || exit 1
echo 'Node.js: '\$(node --version)
npm install && echo '‚úÖ C√†i ƒë·∫∑t ho√†n th√†nh!' && npm start
\""
else
    # Ch·∫°y tr·ª±c ti·∫øp b·∫±ng Node.js (100% th√†nh c√¥ng)
    osascript -e "tell application \"Terminal\" to do script \"
export PATH='/usr/local/bin:/opt/homebrew/bin:/usr/bin:\$PATH'
echo 'üñºÔ∏è Tool Tiny Image v2.0'
echo '======================='
cd '$PROJECT_DIR' || exit 1
echo '‚úÖ Th∆∞ m·ª•c: '\$(pwd)
echo '‚úÖ Node.js: '\$(node --version)
echo ''
echo 'üöÄ Kh·ªüi ch·∫°y Tool Tiny Image...'
node app.js
\""
fi